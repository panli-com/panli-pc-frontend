function closePrompt() {
    var data = jaaulde.utils.cookies.get("closenotshow");
    $('#banqianpanel').remove();
    if (data != null) {
        jaaulde.utils.cookies.set('closenotshow', data + '|order', { domain: 'panli.com' });
    }
    else {
        jaaulde.utils.cookies.set('closenotshow', 'order', { domain: 'panli.com' });
    }
    return false;
} $(function() { $("#selfUrl").focus(function() { $("#urlError").hide(); $(this).select(); return false; }).keydown(function(f) { if (f.keyCode == 13) { $("#spCrawlBtn").click(); return false; } }); $("#spCrawlBtn").click(function() { var e = $("#selfUrl").val(); if ($.trim(e).length <= 0) { $("#urlError").html("<p>请输入商品网址！</p>").show(); return false; } var g = new RegExp("http(s)?://([\\w-]+\\.)+[\\w-]+(/[\\w- ./?%&=]*)?"); if (e.indexOf("http://") < 0 && e.indexOf("https://") < 0) { e = "http://" + e; } if (!g.test(e)) { $("#urlError").html("<p>您输入的链接地址不正确，请核实后再填写！</p>").show(); return false; } if ($("#addInputPanel:visible").length > 0) { alert("请先填写完上一件商品的信息"); return false; } var f = 0; while ($(".w2 a", "#splistPanel").length > f) { if ($(".w2 a:eq(" + (f++) + ")").attr("href") == e) { alert("该商品已经添加！"); return; } } $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/GetProductInfo", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"url":"' + e + '"}', timeout: 15000, beforeSend: function() { $("#spCrawlBtn,#selfUrl").attr("disabled", "disabled"); $("#spLoading").show(); $("#noitemPanel").hide(); }, complete: function() { $("#spLoading").hide(); $("#spCrawlBtn,#selfUrl").removeAttr("disabled"); }, error: function() { alert("网络错误，请稍后再试"); }, success: function(h) { var i = $.parseJSON(h.d); if (i.e != "") { c(i); } else { b(i); } $("#selfUrl").val(""); } }); return false; }); function b(f) { var e = $('<table class="splist"><tr><td class="w1"><a class="spDelBtn" href="' + f.u + '" title="删除"></td><td class="w2"><a href="' + f.u + '" class="pic" target="new"><img onerror="this.src=\'http://sf.panli.com/FrontEnd/images20090801/noimg/noimg80.gif\'" src="' + f.p + '" alt="' + f.n + '" /></a><h3><a href="' + f.u + '" target="new">' + f.n + '</a></h3></td><td class="w3"><a class="jian" href="#" title="减"></a><input type="text" value="' + f.m + '" class="spbuynum" /><a class="jia" href="#" title="加"></a></td><td class="w4"><textarea class="' + (f.r == "" ? "hui" : "") + '" cols="" rows="">' + (f.r == "" ? "请填写商品备注" : f.r) + "</textarea></td></tr></table>"); e.hide(); if ($(".splist:eq(0)").length <= 0) { $("#splistPanel").append(e); } else { $(".splist:eq(0)").before(e); } e.fadeIn(1200); $("#spsubmitPanel").show(); } function c(e) { if (e.e == "Exists") { alert("该商品已经添加！"); return; } a(); $("#addInputPanel").fadeTo(500, 1).data("product", e); } $("#spinputsubmit").click(function() { if ($("#addInputPanel .red").length > 0) { return false; } $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/UdProductName", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"name":"' + $("#spname").val() + '","remark":"' + $("#spremark").val() + '"}', timeout: 15000, beforeSend: function() { $("#spinputsubmit").attr("disabled", "disabled"); }, complete: function() { $("#spinputsubmit").removeAttr("disabled"); }, error: function() { alert("网络错误，请稍后再试"); }, success: function(e) { if (e.d == "success") { var f = $("#addInputPanel").data("product"); f.n = $("#spname").val(); f.r = $("#spremark").val(); f.m = $("#spnum").val(); $("#addInputPanel").hide(); b(f); f.m = parseInt($("#spnum").val()); d(f.u, f.m, ""); return; } alert("添加失败"); } }); return false; }); function a() { $("#spremark,#spname").attr("class", "red"); $("#spname").val("请填写商品名称"); $("#spremark").val("请填写商品备注"); $("#spnum").val("1"); } $("#spinputDel").click(function() { $("#addInputPanel").fadeOut(500, function() { if ($(".splist").length <= 0) { $("#noitemPanel").show(); $("#spsubmitPanel").hide(); } }); return false; }); $(".spDelBtn").live("click", function() { if (!confirm("您确定要删除这件商品吗？")) { return false; } var e = $(this); $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/DelProduct", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"url":"' + e.attr("href") + '"}', timeout: 10000, beforeSend: function() { e.attr("disabled", "disabled"); }, complete: function() { e.removeAttr("disabled"); }, error: function() { alert("网络错误，请稍后再试"); }, success: function(f) { if (f.d == "success") { var g = e.parents(".splist"); g.fadeOut(500, function() { g.remove(); if ($(".splist").length <= 0) { $("#noitemPanel").show(); $("#spsubmitPanel").hide(); } }); } } }); return false; }); $(".jia").live("click", function() { var e = $(this).prev("input"); e.val(parseInt(e.val()) + 1); d($(this).parents(".splist").find(".spDelBtn").attr("href"), e.val(), this); return false; }); $(".jian").live("click", function() { var e = $(this).next("input"); parseInt(e.val()) < 2 ? 1 : e.val(parseInt(e.val()) - 1); d($(this).parents(".splist").find(".spDelBtn").attr("href"), e.val(), this); return false; }); $(".spbuynum").live("keyup", function() { this.value = this.value.replace(/[^\d]/g, ""); }).live("blur", function() { if (this.value.length <= 0) { this.value = 1; } d($(this).parents(".splist").find(".spDelBtn").attr("href"), this.value, this); }); function d(f, e, g) { $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/UpBuynum", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"url":"' + f + '","n":' + e + "}", timeout: 10000, beforeSend: function() { $(g).attr("disabled", "disabled"); }, complete: function() { $(g).removeAttr("disabled"); }, error: function() { alert("网络错误，请稍后再试"); }, success: function() { } }); } $(".w4 textarea").live("focus", function() { var e = $(this).attr("class"); if (e == "hui" || e == "red") { $(this).attr("class", "").val(""); } $(this).data("remark", $.trim($(this).val())); }).live("blur", function() { var e = $(this); var g = e.data("remark"); var f = $.trim(e.val()); if (f.length <= 0) { e.attr("class", "hui").val("请填写商品备注。"); } if (e.parents(".splist").length <= 0) { return; } if (f != g) { $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/UpRemark", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"url":"' + e.parents(".splist").find(".w2 .pic").attr("href") + '","remark":"' + HtmlEncode(f) + '"}', timeout: 10000, error: function() { alert("网络错误，请稍后再试"); e.val(g); }, success: function(h) { if (h.d != "success") { e.val(g); } } }); } }); $("#spname").focus(function() { var e = $(this).attr("class"); if (e == "hui" || e == "red") { $(this).attr("class", "").val(""); } }).blur(function() { if ($.trim($(this).val()).length <= 0) { $(this).attr("class", "red").val("请填写商品名称。"); } }); $("#spsubmit").click(function() { if ($(".splist").length <= 0) { alert("请先提交商品信息"); return false; } $(".splist .w4 .hui").each(function(f, g) { $(this).attr("class", "red"); }); if ($(".splist .w4 .red").length > 0) { return false; } var e = $("#spsubmit"); $.ajax({ type: "POST", url: "/App_Services/wsSelfPurchase.asmx/SpSubmit", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"id":' + $("#selfWarnId").val() + "}", timeout: 10000, beforeSend: function() { e.attr("disabled", "disabled"); }, complete: function() { e.removeAttr("disabled"); }, error: function() { alert("网络错误，请稍后再试"); }, success: function(f) { switch (f.d) { case "error": alert("页面超时"); window.onbeforeunload = null; window.location = window.location.href; return; case "success": window.onbeforeunload = null; window.location = "/mypanli/SelfPurchase/List.aspx"; return; default: alert("提交失败，请重试"); return; } } }); return false; }); window.onbeforeunload = function() { if ($(".splist,#addInputPanel:visible").length > 0) { return "刷新当前页面，您输入的内容将不被保存，确定要继续吗?"; } }; });