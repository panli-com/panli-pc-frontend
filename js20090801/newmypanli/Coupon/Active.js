$(function() { var couponList = { d: 0, l: [] }; var listHtml = $("#userCouponList"); var buildlist = function(i, jq) { $.ajax({ type: "POST", url: "/App_Services/wsCouponManage.asmx/GetUserUnactivatedCoupon", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"pages":' + i + "}", timeout: 15000, beforeSend: function() { $("#userCouponList").hide(); $("#loading").show() }, error: function() { }, success: function(r) { var temp = eval("(" + r.d + ")"); if (couponList.n != temp.n) { jq.AjaxPager({ sum_items: temp.n, current_page: i, items_per_page: 10, callback: buildlist }) } couponList = temp; if (couponList.n <= 0) { $("#loading").hide(); $("#userCouponListPanel").hide(); $("#noneList").show(); return } if (couponList.l.length > 0) { $("#noneList").hide(); $("#userCouponListPanel").show(); var t = $("#userCouponList"); t.empty(); $.each(couponList.l, function(index, item) { var inputString = ""; if (item.f == 0) { inputString = '<input name="" type="button" value="马上激活" onclick="ActivateCoupon(\'' + item.n + "','" + item.t + "',false)\" />" } else { inputString = "已过激活期！" } t.append('<tr><td class="w1" id="' + item.n + '"><img src="http://sf.panli.com/FrontEnd/images20090801/newmypanli/score/q' + item.m + '.jpg" alt="' + item.m + '元优惠券" /></td><td class="w2">' + item.n + '</td><td class="w3">' + item.d + '</td><td class="w4">' + item.m + '元</td><td class="w5">' + inputString + "</td></tr>") }); $("#loading").hide(); t.show() } } }) }; buildlist(1, $("#ajaxPager")) }); function ActivateCoupon(a, b, c) { var d = '"' + a + '"'; $.ajax({ type: "POST", url: "/App_Services/wsCouponManage.asmx/ActivateCoupon", cache: false, dataType: "json", contentType: "application/json;utf-8", data: '{"code":' + d + "}", timeout: 15000, error: function(e) { $("#showContent").html("您输入的号码为无效号码，请输入正确的优惠券号码。") }, success: function(e) { if (c) { ClickToActivate(e.d, b, a) } else { ShowActivate(e.d, b, a) } } }) } function ShowActivate(b, c, a) { if (b == "Success") { ShowSuccess(c, a) } else { alert("兑换失败！") } } function ClickToActivate(b, c, a) { switch (b) { case "Error": $("#showContent").html("您输入的号码为无效号码，请输入正确的优惠券号码。"); break; case "Success": ShowSuccess(c, a); case "Expired": $("#showContent").html("该电子优惠券已过激活期！"); break; case "Nonexistent": $("#showContent").html("该电子优惠券不存在。"); break; case "Activated": $("#showContent").html("该电子优惠券已激活。"); break; case "Forbidden": $("#showContent").html("该电子优惠券只能是指定的账户激活及使用。如有问题，可与客服联系。"); break; default: alert("网络错误请稍后再试！"); break } } function Click() { $("#showContent").show(); var b = $.trim($("#clickcode").val()); var a = new RegExp("^([A-Za-z0-9]{5})-([A-Za-z0-9]{5})-([A-Za-z0-9]{5})-([A-Za-z0-9]{5})-([A-Za-z0-9]{5})$"); if (b == "") { $("#showContent").html("请输入电子优惠券的号码。") } else { if (a.test(b)) { ActivateCoupon(b, true) } else { $("#showContent").html("您输入的号码为无效号码，请输入正确的优惠券号码。") } } } function ShowSuccess(d, b) { $("#showContent").html(""); $("#loading").hide(); $(".shuru").hide(); $("#userCouponListPanel").hide(); $("#userCouponList").hide(); $("#ajaxPager").hide(); $("#noneList").hide(); var c = new Array(); c = $("#BeijingDate").html().replace("北京时间：", "").split("-"); var a = new Date(); a.setFullYear(c[0], c[1], c[2]); if (d == "活动抽奖") { a.setMonth(a.getMonth() + 1) } else { a.setMonth(a.getMonth() + 2) } $(".succeed").append("<h2> 恭喜！您的电子优惠券已成功激活！</h2><span>本次激活的电子优惠券号码为" + b + "，有效期至" + a.getFullYear() + "-" + a.getMonth() + "-" + a.getDate() +" "+ a.getHours() + ":" + a.getMinutes() + ":" + a.getSeconds() + '！</span><div class="jxl"><h3>接下来您是不是要：</h3><p><a href="/mypanli/Coupon/">查看我的优惠券</a><i>或者</i><a href="/mypanli/Coupon/Active.aspx">继续激活优惠券</a></p></div>').show() } $(document).ready(function() { $("#clickcode").keydown(function(a) { if (a.keyCode == 13) { Click(); return false } }); $("#clickcode").keyup(function() { if ($.trim($("#clickcode").val()) == "") { $("#showContent").hide() } }); $("#clickcode").focus(function() { if ($.trim($("#clickcode").val()) == "") { $("#showContent").hide() } }); $("#clickcode").blur(function() { if ($.trim($("#clickcode").val()) == "") { $("#showContent").hide() } }) });