$(function(){var d=[];var c=[];$(".pmTag").click(function(){$(".pmTag").parent("li").toggleClass("p_on");$(".pmPanel").toggle();a();return false;});$("#pmUrl").focus(function(){$("#pmUrlError").hide();$(this).select();});$("#pmSnatchBtn").click(function(){$("#pmUrlError").hide();var f=$.trim($("#pmUrl").val());if(f.length<=0){$("#pmUrlError").html("<p>请输入代付款链接</p>").show();return false;}if(f.indexOf("http://")==-1&&f.indexOf("https://")==-1){f="http://"+f;}var h=new RegExp("http(s)?://([\\w-]+\\.)+[\\w-]+(/[\\w- ./?%&=]*)?");if(!h.test(f)){$("#pmUrl").val("");$("#pmUrlError").html("<p>您输入的代付款链接有误，请重新输入</p>").show();return false;}for(var g=0;g<d.length;g++){if(d[g].u==f){$("#pmUrl").val("");$("#pmUrlError").html("<p>您已经抓取过这条代付款链接了喔！</p>").show();return false;}}$.ajax({type:"POST",url:"/App_Services/wsSelfPurchase.asmx/GetPaymentInfo",cache:false,dataType:"json",contentType:"application/json;utf-8",data:'{"url":"'+f+'"}',timeout:15000,beforeSend:function(){$("#pmLoading").show();},complete:function(){$("#pmLoading").hide();},error:function(){alert("网络错误！请稍后重试");},success:function(k){$("#pmUrl").val("");var j=$.parseJSON(k.d);switch(j.error){case"":break;case"noLogin":alert("登陆超时，请刷新页面重试");return;case"wrongAddress":alert("代付款包裹物流地址错误");return;case"fail":$("#pmUrl").val("");$("#pmUrlError").html("<p>您输入的代付款链接有误，请重新输入</p>").show();return false;default:alert("抓取失败！请稍后重试");return;}$(".pmPanel:visible .pmSnatchPrompt").hide();var i=$('<table class="p1"><tr><td class="b1"><a href="#" class="pmDelBtn"><img src="http://sf.panli.com/FrontEnd/images20090801/newmypanli/payment/s1.gif" alt="删除" /></a></td><td class="b2">'+j.i+'</td><td class="b3">'+j.n+'</td><td class="b4">￥'+j.p+"</td></tr></table>");$(".pmPanel:visible").append(i);i.fadeIn(1000);$(".dingdan .p1:visible").css("background-color","");$(".dingdan .p1:visible:odd").css("background-color","#f5fbfd");d.push(j);a();}});return false;});$("#pm2shopinfo").keyup(function(){var h=$(this).val();var f=new RegExp("[\\u4e00-\\u9fa5]","g");var g=h.length;while(f.exec(h)!=null){g++;}if(g>30){$(this).val(h.substring(0,h.length-1));$("#pm2shopinfo").keyup();}});$("#pm2dealNo").focus(function(){$(this).next("p").removeClass("error").text("请输入代付款交易号");});$("#pm2shopinfo").focus(function(){$(this).next("p").removeClass("error").text("请输入卖家的淘宝用户名");});$("#pm2Price").focus(function(){$(this).next("p").removeClass("error").text("请填写代付款金额(含邮费)");});$("#pmAddBtn").click(function(){var i=$.trim($("#pm2dealNo").val());var h=$.trim($("#pm2Price").val());var j=parseFloat(h);var k=$.trim($("#pm2shopinfo").val());if(i.length<=0){$("#pm2dealNo").next("p").addClass("error");return false;}if(k.length<=0){$("#pm2shopinfo").next("p").addClass("error");return false;}if(h.length<=0){$("#pm2Price").next("p").addClass("error").text("输入整数或小数，小数点后不超过2位");return false;}if(!new RegExp("^\\d+(.\\d{1,2})?$").test(h)){$("#pm2Price").next("p").addClass("error").text("您输入的金额有误，请重新输入！");return false;}if(c.length>0){for(var f=0;f<c.length;f++){if(c[f].n==i){alert("该代付款请求已经添加！");return false;}}}$(".pmPanel:visible .pmSnatchPrompt").hide();var g=$('<table class="p1"><tr><td class="b1"><a href="#" class="pmDelBtn"><img src="http://sf.panli.com/FrontEnd/images20090801/newmypanli/payment/s1.gif" /></a></td><td class="b5">'+k+'</td><td class="b6">'+i+'</td><td class="b4">￥'+j+"</td></tr></table>");$(".pmPanel:visible").append(g);g.fadeIn(1000);$(".dingdan .p1:visible").css("background-color","");$(".dingdan .p1:visible:odd").css("background-color","#f5fbfd");c.push({u:"http://www.panli.com",n:i,p:j,i:k});$("#payments2 :text").val("");a();});$(".pmDelBtn").live("click",function(){var f=$.trim($(this).parents(".p1").find($("#pmSnatchBtn:visible").length>0?".b3":".b6").text());if($("#pmSnatchBtn:visible").length>0){d=$.grep(d,function(h,g){return h.n!=f;});}else{c=$.grep(c,function(h,g){return h.n!=f;});}$(this).parents(".p1").fadeOut(1000,function(){$(this).remove();$(".dingdan .p1:visible").css("background-color","");$(".dingdan .p1:visible:odd").css("background-color","#f5fbfd");a();if($(".dingdan .p1:visible").length<=0){$(".pmPanel:visible .pmSnatchPrompt").show();b();return false;}});return false;});function b(f){if(!!f){$("#submitPanel p").html('<img src="http://sf.panli.com/FrontEnd/images20090801/newmypanli/payment/z_1.gif" alt="error" />'+f).show();}else{$("#submitPanel p").hide();}$("#pmSubmit").attr({disabled:"disabled","class":"c_no"});}function e(){$("#submitPanel p").hide();$("#pmSubmit").attr("class","tj").removeAttr("disabled");}function a(){var j=0,g=0;var f=$("#pmSnatchBtn:visible").length>0?d:c;if(f.length<=0){b();return false;}for(var l=0;l<f.length;l++){var k=parseFloat(f[l].p);j+=k;g+=parseFloat((k/10).toFixed(2));}$("#pmAmount").text("￥"+j.toFixed(2));$("#pmFee").text("￥"+g.toFixed(2));$("#pmTotalPrice").text("￥"+(j+g).toFixed(2));var h=parseFloat($("#userCurrentPrice").val());if(j+g>h){b("对不起！您的账户余额不足，请充值后再试！");}else{e();}}$("#pmSubmit").click(function(){if($("#pmSnatchBtn:visible").length>0){if(d.length<=0){b("请先添加代付款链接");return false;}}else{if(c.length<=0){b("请添加代付记录后再提交支付！");return false;}}var g=$("#pmSnatchBtn:visible").length>0?d:c;var f="[";var k=0;for(var j=0;j<g.length;j++){var h=(g[j].u+"<#>"+g[j].n+"<#>"+g[j].p+"<#>"+g[j].i).replace(/\"/g,"");f+='"'+h+'",';}f=f.substring(0,f.lastIndexOf(","))+"]";$.ajax({type:"POST",url:"/App_Services/wsSelfPurchase.asmx/PaymentApply",cache:false,dataType:"json",contentType:"application/json;utf-8",data:'{"para":'+f+"}",timeout:15000,beforeSend:function(){$("#pmSubmit").attr("disabled","disabled");},complete:function(){$("#pmSubmit").removeAttr("disabled");},error:function(){alert("网络错误！请稍后重试");},success:function(l){var i=$.parseJSON(l.d);if(i.r=="Success"){$("#pmMainPanel").attr("class","cg").html('<div class="succeed"><h2>恭喜您！成功提交了代付款申请</h2><p>本次共支付了<span>'+i.p+'</span>元，我们将在<span>1</span>个工作日内为您代付款，请耐心等待。</p><em>代付款成功后，请使用自助购物服务提交本次代付款的商品链接，以便于我们为您验货。</em><a class="cj" href="/mypanli/SelfPurchase/Order.aspx">立即使用自助购物</a><a class="qita" href="/mypanli/payment/Record.aspx">查看代付款记录</a></div>');window.onbeforeunload=null;$(window).scrollTop(0);}else{if(i.r=="BalanceLack"){alert("余额不足");}else{alert("数据错误，请刷新页面重新提交");}}}});return false;});});window.onbeforeunload=function(){if($(".dingdan .p1:visible").length>0){return"关闭、刷新当前页面数据会被清空，确定要这么做吗？";}};